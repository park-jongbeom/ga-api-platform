name: JIRA Progress Report

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1'  # 매주 월요일 09:00 UTC

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python dependencies
        run: pip install requests

      - name: Generate JIRA report
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          mkdir -p reports
          REPORT_DATE=$(date +%Y-%m-%d)
          python3 .github/scripts/jira-generate-report.py \
            --project-key GAM \
            --report-web-url "https://go-almond.ddnsfree.com/" \
            --canonical-only \
            --output "reports/report-${REPORT_DATE}.md" \
            --date "${REPORT_DATE}"
          echo "REPORT_DATE=${REPORT_DATE}" >> $GITHUB_OUTPUT

      - name: Copy report to report-latest.md
        if: success()
        run: |
          REPORT_DATE=$(date +%Y-%m-%d)
          REPORT_FILE="reports/report-${REPORT_DATE}.md"
          if [ -f "$REPORT_FILE" ]; then
            cp "$REPORT_FILE" reports/report-latest.md
            echo "report-latest.md 업데이트됨"
          fi

      - name: Create or update date-based GitHub Issue (중복 이슈 방지)
        if: success()
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPORT_DATE=$(date +%Y-%m-%d)
          REPORT_FILE="reports/report-${REPORT_DATE}.md"
          TITLE="프로젝트 진행 상황 보고서 - ${REPORT_DATE}"
          if [ ! -f "$REPORT_FILE" ]; then exit 0; fi
          BODY=$(python3 -c "import json,sys; print(json.dumps(open(sys.argv[1]).read()))" "$REPORT_FILE")
          EXISTING=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?labels=report&state=open&per_page=50" \
            | python3 -c "
          import json,sys
          data=json.load(sys.stdin)
          title='${TITLE}'
          for i in data:
            if i.get('title')==title:
              print(i.get('number','')); break
          " 2>/dev/null || true)
          if [ -n "$EXISTING" ]; then
            echo "기존 날짜별 보고서 이슈 #${EXISTING} 본문 업데이트"
            curl -s -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${EXISTING}" \
              -d "{\"body\":${BODY}}" || true
          else
            echo "새 날짜별 보고서 이슈 생성"
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues" \
              -d "{\"title\":\"${TITLE}\",\"body\":${BODY},\"labels\":[\"report\",\"status-update\"]}" || true
          fi

      - name: Create or update latest GitHub Issue (최신 보고서 한곳)
        if: success()
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_FILE="reports/report-latest.md"
          TITLE_LATEST="프로젝트 진행 상황 보고서 (최신)"
          if [ ! -f "$LATEST_FILE" ]; then exit 0; fi
          BODY=$(python3 -c "import json,sys; print(json.dumps(open(sys.argv[1]).read()))" "$LATEST_FILE")
          EXISTING=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?labels=report&state=open&per_page=50" \
            | python3 -c "
          import json,sys
          data=json.load(sys.stdin)
          title='${TITLE_LATEST}'
          for i in data:
            if i.get('title')==title:
              print(i.get('number','')); break
          " 2>/dev/null || true)
          if [ -n "$EXISTING" ]; then
            echo "최신 보고서 이슈 #${EXISTING} 본문 업데이트"
            curl -s -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${EXISTING}" \
              -d "{\"body\":${BODY}}" || true
          else
            echo "최신 보고서 이슈 생성"
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues" \
              -d "{\"title\":\"${TITLE_LATEST}\",\"body\":${BODY},\"labels\":[\"report\",\"latest\"]}" || true
          fi

      - name: Commit and push report files
        if: success()
        run: |
          REPORT_DATE=$(date +%Y-%m-%d)
          REPORT_FILE="reports/report-${REPORT_DATE}.md"
          LATEST_FILE="reports/report-latest.md"
          if [ -f "$REPORT_FILE" ] || [ -f "$LATEST_FILE" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            [ -f "$REPORT_FILE" ] && git add "$REPORT_FILE"
            [ -f "$LATEST_FILE" ] && git add "$LATEST_FILE"
            git diff --staged --quiet || (git commit -m "docs: JIRA 진행 보고서 ${REPORT_DATE} 및 report-latest [skip ci]" && git push) || true
          fi
