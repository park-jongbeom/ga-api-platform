# =========================================================
# Prometheus Alert 규칙
# =========================================================
# AI 상담 서비스 알림 규칙
# =========================================================

groups:
  # AI 상담 서비스 알림
  - name: ai_consultant_alerts
    interval: 30s
    rules:
      # 높은 오류율
      - alert: HighErrorRate
        expr: |
          rate(consultant_chat_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          component: consultant-service
        annotations:
          summary: "AI 상담 오류율 5% 초과"
          description: "지난 5분간 오류율이 {{ $value | humanizePercentage }}입니다."
          action: "로그 확인 및 LLM API 상태 점검"
      
      # 느린 응답 시간
      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(consultant_chat_processing_seconds_bucket[5m])
          ) > 5
        for: 3m
        labels:
          severity: warning
          component: consultant-service
        annotations:
          summary: "AI 상담 응답 시간 지연"
          description: "95 percentile 응답 시간이 {{ $value }}초입니다."
          action: "성능 프로파일링 실행, DB 쿼리 최적화"
      
      # 프롬프트 인젝션 급증
      - alert: PromptInjectionSpike
        expr: |
          increase(prompt_injection_blocked_total[1h]) > 10
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "프롬프트 인젝션 시도 급증"
          description: "지난 1시간 동안 {{ $value }}건의 프롬프트 인젝션 차단"
          action: "보안 로그 분석, IP 차단 검토"
      
      # RAG 검색 실패율
      - alert: RagSearchFailureRate
        expr: |
          rate(rag_search_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: rag-service
        annotations:
          summary: "RAG 검색 실패율 10% 초과"
          description: "벡터 검색 실패율이 높습니다."
          action: "PostgreSQL 상태 점검, pgvector 인덱스 확인"
      
      # LLM API 오류
      - alert: LlmApiErrors
        expr: |
          rate(llm_api_errors_total[5m]) > 0.02
        for: 2m
        labels:
          severity: critical
          component: llm-integration
        annotations:
          summary: "LLM API 오류율 2% 초과"
          description: "OpenAI API 호출 실패율이 높습니다."
          action: "OpenAI 상태 페이지 확인, 재시도 로직 검토"
      
      # 서비스 다운
      - alert: ServiceDown
        expr: |
          up{job="ga-ai-consultant-service"} == 0
        for: 1m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "AI 상담 서비스 다운"
          description: "서비스가 응답하지 않습니다."
          action: "즉시 서비스 재시작, 로그 확인"

  # 데이터베이스 알림
  - name: database_alerts
    interval: 30s
    rules:
      # DB 연결 실패
      - alert: DatabaseConnectionFailure
        expr: |
          rate(hikaricp_connections_creation_failed_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "DB 연결 풀 생성 실패"
          description: "데이터베이스 연결 실패가 발생했습니다."
          action: "DB 상태 확인, 연결 풀 설정 검토"
      
      # 느린 쿼리
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            rate(spring_data_repository_invocations_seconds_bucket[5m])
          ) > 0.5
        for: 3m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "DB 쿼리 지연"
          description: "95% 쿼리 실행 시간이 {{ $value }}초입니다."
          action: "EXPLAIN ANALYZE 실행, 인덱스 최적화"
      
      # 연결 풀 고갈
      - alert: ConnectionPoolExhaustion
        expr: |
          hikaricp_connections_active / hikaricp_connections_max > 0.9
        for: 2m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "DB 연결 풀 고갈 임박"
          description: "활성 연결이 최대 연결 수의 {{ $value | humanizePercentage }}입니다."
          action: "연결 풀 크기 증가 검토"

  # 시스템 리소스 알림
  - name: system_alerts
    interval: 30s
    rules:
      # 높은 메모리 사용률
      - alert: HighMemoryUsage
        expr: |
          jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.85
        for: 3m
        labels:
          severity: warning
          component: jvm
        annotations:
          summary: "JVM 힙 메모리 사용률 85% 초과"
          description: "메모리 사용률이 {{ $value | humanizePercentage }}입니다."
          action: "힙 덤프 분석, 메모리 누수 확인"
      
      # GC 시간 증가
      - alert: HighGcTime
        expr: |
          rate(jvm_gc_pause_seconds_sum[5m]) > 0.1
        for: 3m
        labels:
          severity: warning
          component: jvm
        annotations:
          summary: "GC 시간 비율 증가"
          description: "GC에 {{ $value | humanizePercentage }}의 시간을 사용 중입니다."
          action: "GC 로그 분석, 힙 크기 조정"
      
      # CPU 사용률
      - alert: HighCpuUsage
        expr: |
          process_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "CPU 사용률 80% 초과"
          description: "CPU 사용률이 {{ $value | humanizePercentage }}입니다."
          action: "CPU 프로파일링, 부하 분산 검토"

  # 비즈니스 메트릭 알림
  - name: business_alerts
    interval: 60s
    rules:
      # 낮은 RAG 검색 결과
      - alert: LowRagSearchResults
        expr: |
          avg_over_time(rag_search_documents_found[10m]) < 1
        for: 5m
        labels:
          severity: info
          component: rag-service
        annotations:
          summary: "RAG 검색 결과 부족"
          description: "평균 검색 문서 수가 {{ $value }}개입니다."
          action: "문서 인덱싱 상태 확인, 임베딩 품질 검토"
      
      # 마스킹 빈도 급증
      - alert: HighMaskingFrequency
        expr: |
          rate(masking_tokens_created_total[10m]) > 100
        for: 5m
        labels:
          severity: info
          component: security
        annotations:
          summary: "민감정보 마스킹 빈도 증가"
          description: "마스킹 토큰 생성 속도가 높습니다."
          action: "사용자 행동 패턴 분석"
