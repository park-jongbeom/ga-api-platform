# =========================================================
# Alertmanager ì„¤ì •
# =========================================================
# ì•Œë¦¼ ì±„ë„ ë° ë¼ìš°íŒ… ê·œì¹™
# =========================================================

global:
  # Slack Webhook URL (í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê¶Œì¥)
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # SMTP ì„¤ì • (ì´ë©”ì¼ ì•Œë¦¼)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@goalmond.com'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# ì•Œë¦¼ ë¼ìš°íŒ…
route:
  # ê¸°ë³¸ ìˆ˜ì‹ ì
  receiver: 'default'
  
  # ê·¸ë£¹í™” ì„¤ì • (ë™ì¼ ë¼ë²¨ì˜ ì•Œë¦¼ì„ ë¬¶ìŒ)
  group_by: ['alertname', 'severity', 'component']
  
  # ê·¸ë£¹í™” ëŒ€ê¸° ì‹œê°„
  group_wait: 10s
  
  # ê°™ì€ ê·¸ë£¹ì˜ ì¶”ê°€ ì•Œë¦¼ ëŒ€ê¸° ì‹œê°„
  group_interval: 5m
  
  # ê°™ì€ ì•Œë¦¼ ì¬ì „ì†¡ ê°„ê²©
  repeat_interval: 4h
  
  # ë¼ìš°íŒ… ê·œì¹™
  routes:
    # Critical ì•Œë¦¼ì€ ì¦‰ì‹œ Slack + ì´ë©”ì¼
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 30m
    
    # Warning ì•Œë¦¼ì€ Slackë§Œ
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_interval: 10m
    
    # Info ì•Œë¦¼ì€ ì´ë©”ì¼ë¡œ ì¼ì¼ ìš”ì•½
    - match:
        severity: info
      receiver: 'info-alerts'
      group_interval: 24h

# ìˆ˜ì‹ ì ì„¤ì •
receivers:
  # ê¸°ë³¸ ìˆ˜ì‹ ì (ëª¨ë“  ì•Œë¦¼)
  - name: 'default'
    slack_configs:
      - channel: '#ai-consultant-alerts'
        title: 'âš ï¸ {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Action:* {{ .CommonAnnotations.action }}
          
          *Details:*
          {{ range .Alerts }}
            - {{ .Labels.instance }}: {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # Critical ì•Œë¦¼ (ê¸´ê¸‰)
  - name: 'critical-alerts'
    slack_configs:
      - channel: '#ai-consultant-critical'
        username: 'AlertBot'
        icon_emoji: ':rotating_light:'
        title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Severity:* CRITICAL
          *Component:* {{ .GroupLabels.component }}
          *Summary:* {{ .CommonAnnotations.summary }}
          
          *Immediate Action Required:*
          {{ .CommonAnnotations.action }}
          
          *Affected Instances:*
          {{ range .Alerts }}
            â€¢ {{ .Labels.instance }}: {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'devops@goalmond.com'
        headers:
          Subject: '[CRITICAL] AI ìƒë‹´ ì„œë¹„ìŠ¤ ì¥ì• : {{ .GroupLabels.alertname }}'
        html: |
          <h2>ğŸš¨ ê¸´ê¸‰ ì•Œë¦¼</h2>
          <p><strong>{{ .CommonAnnotations.summary }}</strong></p>
          <p>{{ .CommonAnnotations.description }}</p>
          <hr>
          <p><strong>ì¡°ì¹˜ ì‚¬í•­:</strong></p>
          <p>{{ .CommonAnnotations.action }}</p>
  
  # Warning ì•Œë¦¼ (ê²½ê³ )
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#ai-consultant-warnings'
        title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
        text: |
          *Component:* {{ .GroupLabels.component }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Action:* {{ .CommonAnnotations.action }}
        send_resolved: true
  
  # Info ì•Œë¦¼ (ì •ë³´)
  - name: 'info-alerts'
    email_configs:
      - to: 'team@goalmond.com'
        headers:
          Subject: '[INFO] AI ìƒë‹´ ì„œë¹„ìŠ¤ ì¼ì¼ ë¦¬í¬íŠ¸'
        html: |
          <h2>ğŸ“Š ì¼ì¼ ë¦¬í¬íŠ¸</h2>
          <ul>
          {{ range .Alerts }}
            <li>{{ .Annotations.summary }}</li>
          {{ end }}
          </ul>

# ì•Œë¦¼ ì–µì œ ê·œì¹™ (ì¤‘ë³µ ë°©ì§€)
inhibit_rules:
  # ServiceDownì´ ë°œìƒí•˜ë©´ ë‹¤ë¥¸ ì•Œë¦¼ ì–µì œ
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']
  
  # Critical ì•Œë¦¼ ë°œìƒ ì‹œ Warning ì–µì œ
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'component']
